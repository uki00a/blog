<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width"><title>deno test --docでREADME.mdをうまくテストする - uki00a.github.io</title><meta name="title" content="deno test --docでREADME.mdをうまくテストする - uki00a.github.io"><meta name="description"><meta property="og:type" content="website"><meta property="og:title" content="deno test --docでREADME.mdをうまくテストする - uki00a.github.io"><meta property="og:description"><meta property="og:image" content="https://raw.githubusercontent.com/uki00a/blog/master/src/assets/avatar.png"><meta property="twitter:card" content="summary_large_image"><meta property="twitter:title" content="deno test --docでREADME.mdをうまくテストする - uki00a.github.io"><meta property="twitter:description"><meta property="twitter:image" content="https://raw.githubusercontent.com/uki00a/blog/master/src/assets/avatar.png"><meta name="twitter:site" content="@uki00a"><link rel="preconnect" href="https://fonts.gstatic.com"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono&amp;family=IBM+Plex+Sans:wght@400;700&amp;display=swap"><link rel="stylesheet" href="/_astro/common-16LM0s.css" type="text/css"><link rel="icon" href="https://raw.githubusercontent.com/uki00a/blog/master/src/assets/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism.min.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-core.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/plugins/autoloader/prism-autoloader.min.js"></script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-R8RKYMTR71"></script><script>window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'G-R8RKYMTR71');</script></head><body class="bg-gray-100 overoll-y-scroll"><header class="bg-yellow-300 bg-gradient-r p-3 flex justify-between"><a class="text-xl text-white font-bold" href="https://uki00a.github.io/blog">
        uki00a.github.io
      </a><div class="hidden md:block"><a class="text-white text-lg mr-3 font-semibold" target="_blank" href="https://github.com/uki00a/blog">
          GitHub
        </a><a class="text-white text-lg font-semibold" target="_blank" href="https://twitter.com/uki00a">
          Twitter
        </a></div></header><main class="container mx-auto min-h-screen bg-gradient-r"><article class="p-4 bg-gray-100"><style global="" type="text/css">
  .markdown-body ul {
    margin-bottom: 1rem;
    list-style-position: inside;
    list-style-type: disc;
    padding-left: 1rem
}
  .markdown-body h1, h2, h3 {
    margin-bottom: 1rem;
    font-weight: 700
}
  .markdown-body h1, h2 {
    border-bottom-width: 2px;
    border-style: solid;
    --tw-border-opacity: 1;
    border-color: rgba(229, 231, 235, var(--tw-border-opacity))
}
  .markdown-body h1 {
    padding-bottom: 0.5rem;
    font-size: 1.875rem;
    line-height: 2.25rem
}
  .markdown-body h2 {
    font-size: 1.5rem;
    line-height: 2rem
}
  .markdown-body h3 {
    font-size: 1.125rem;
    line-height: 1.75rem
}
  .markdown-body p {
    margin-bottom: 1rem
}
  .markdown-body a {
    --tw-text-opacity: 1;
    color: rgba(59, 130, 246, var(--tw-text-opacity))
}
  .markdown-body :not(pre) > code {
    --tw-bg-opacity: 1;
    background-color: rgba(229, 231, 235, var(--tw-bg-opacity));
    padding: 0.25rem
}
  </style><div class="markdown-body shadow-md p-8 astro-WBggsFB8"><h1 class="astro-WBggsFB8">deno test --docでREADME.mdをうまくテストする</h1><div><a href="https://uki00a.github.io/blog/tags/deno" class="text-blue-500 pr-1">
        #deno</a></div><div class="mb-4 astro-WBggsFB8"></div><h2 id="はじめに">はじめに</h2><p><a href="https://deno.com/blog/v1.13">Deno v1.13</a>から<code>deno test --doc</code>コマンドでMarkdownファイルがサポートされました。</p><p>この機能を利用することで、<code>README.md</code>などに記述したサンプルコードの型チェックをすることができます。</p><p>そのため、Denoモジュールを<a href="https://deno.land/x">deno.land/x</a>や<a href="https://nest.land/">nest.land</a>などに公開する場合、サンプルコードが正しく動作することを保証するのにとても役立ちます。</p><h2 id="問題">問題</h2><p><code>README.md</code>などにサンプルコードを記述する際は、以下のように<code>import</code>節には<a href="https://deno.land/x">deno.land/x</a>の公開URLを記述することが一般的だと思います。</p><p>例)</p><pre class=" language-markdown"><code class="language-markdown">  <span class="token title important"><span class="token punctuation">##</span> Usage</span>

  ```ts
  import { connect } from "https://deno.land/x/redis/mod.ts";
  
  const redis = await connect({ hostname: "127.0.0.1" });
  await redis.set("foo", "bar");
  const value = await redis.get("foo");
  console.assert(typeof value === "string");
  await redis.del("foo");
  ```
</code></pre><p>この場合、モジュールは<code>https://deno.land/x/redis/mod.ts</code>から読み込まれてしまうため、<strong>CIなどで最新状態のソースに対してテストができない</strong>問題があります。</p><h2 id="解決策">解決策</h2><p>この問題は<a href="https://deno.land/manual@v1.13.1/linking_to_external_code/import_maps">Import maps</a>を使用することで解決できます。</p><p>以下のように<code>import_map.test.json</code>を用意します。</p><pre class=" language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"imports"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"https://deno.land/x/redis/mod.ts"</span><span class="token operator">:</span> <span class="token string">"./mod.ts"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>そして、<code>deno test --doc</code>コマンドを実行する際に<code>--import-map</code>オプションでこのファイルを指定します。</p><pre class=" language-shell"><code class="language-shell">$ deno <span class="token builtin class-name">test</span> --doc --no-run --import-map<span class="token operator">=</span>import_map.test.json README.md
</code></pre><p>こうすることで、<code>https://deno.land/x/redis/mod.ts</code>が<code>./mod.ts</code>の読み込みに置き換えられるため、ローカルの最新状態の<code>mod.ts</code>に対してテストすることができます。</p><h2 id="参考">参考</h2><ul><li><a href="https://deno.com/blog/v1.13">Deno 1.13 Release Notes</a></li></ul><h3 id="環境">環境</h3><ul><li>Deno v1.13.1</li></ul></div></article></main><script>
    document.querySelectorAll('link[href^="/_astro"]').forEach(function(el) {
      // TODO: Unable to fetch CSS files on github pages
      const link = document.createElement("link");
      const url = new URL(el.href);
      url.pathname = "/blog" + url.pathname;
      link.href = url.href;
      link.rel = "stylesheet";
      document.body.appendChild(link);
    });
    </script></body></html>